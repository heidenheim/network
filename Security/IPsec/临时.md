学习版（逐行解释：它在干嘛、为什么）


R1：接口与路由（让两端公网/内网都可达）

```
interface e0/0
 ip address 200.1.1.1 255.255.255.0   ! 公网口IP（从这里对外建隧道）
 no shut                                ! 开口

interface e0/1
 ip address 10.1.1.254 255.255.255.0   ! 内网口，做PC1网关
 no shut

ip route 10.2.2.0 255.255.255.0 200.1.1.2
! 去对端内网的“明文去路”，至少保证能把触发包丢到对端公网
```

为什么：IKE 报文和加密后的 ESP 都要走公网链路；没有基础连通，谈判发不出去。


R1：Phase 1（先建“安全谈判通道”，即 IKEv1/ISAKMP SA）

```
crypto isakmp policy 10
 encryption aes                ! 谈判报文本身用AES加密（机密性）
 hash sha                      ! 用SHA（通常是SHA-1）做完整性校验
 authentication pre-share      ! 身份校验方式=预共享密钥（PSK）
 group 2                       ! DH组=2，用来安全地产生共享密钥
 lifetime 86400                ! IKE SA 寿命（秒），到期会重谈

crypto isakmp key CISCO123 address 200.1.1.2
! 面向对端公网200.1.1.2的预共享口令= CISCO123
```

为什么：这是“保密热线”的规格与暗号。两端至少有一条 policy 匹配（加密/哈希/认证/DH）+ 用同一把 PSK，才能把“谈判通道”建起来。

R1：Phase 2（再建“数据加密通道”，即 IPsec SA）

```
crypto ipsec transform-set TS esp-aes esp-sha-hmac
 mode tunnel
```

`TS`：给这组“数据加密方案”起的名字；

`esp-aes`：业务数据用 ESP+AES 加密（保密性）；

`esp-sha-hmac`：ESP里用 HMAC-SHA 做完整性验证（没被改）；

`mode tunnel`：隧道模式（站点到站点常用）。

为什么：Phase 2 才是真正“运货”（加密业务流量）的规格，双方必须一致。

R1：哪些流量要进隧道（选择器）

```
access-list 100 permit ip 10.1.1.0 0.0.0.255 10.2.2.0 0.0.0.255
```

这是扩展 ACL（编号100），定义“有趣流量”：本端内网 → 对端内网。

R2 上必须“镜像”匹配（把源/目的对调），否则 Phase 2 谈不拢或单向。

为什么：不是所有流量都要加密。ACL 明确“哪些源/目的”走隧道，其余照常明文或NAT上网。


R1：把对端+数据方案+选择器捆成一份“隧道方案”，并贴到公网口

```
crypto map VPN 10 ipsec-isakmp
 set peer 200.1.1.2        ! 对端公网IP
 set transform-set TS      ! 用哪套数据加密方案（上面定义的 TS）
 match address 100         ! 哪些流量走这条隧道（ACL 100）

interface e0/0
 crypto map VPN            ! 把隧道方案贴到出公网的接口
```

为什么：只有“贴口”，设备在这个口看到“有趣流量”时才会触发 IKE → 建 IPsec → 把包封进 ESP 发给对端。